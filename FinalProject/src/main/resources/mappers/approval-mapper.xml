<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.demo.approval.model.mapper.ApprovalMapper">

    <resultMap id="approvalResultMap" type="com.example.demo.approval.model.dto.ApprovalDto">
        <id property="docNo" column="DOC_NO"/>
        <result property="empNo" column="EMP_NO"/>
        <result property="approvalDate" column="APPROVAL_DATE"/>
        <result property="retentionYear" column="RETENTION_YEAR"/>
        <result property="approvalTitle" column="APPROVAL_TITLE"/>
        <result property="approvalContent" column="APPROVAL_CONTENT"/>
        <result property="approvalStatus" column="APPROVAL_STATUS"/>
        <result property="approvalFile" column="APPROVAL_FILE"/>
        <result property="relatedDocNo" column="RELATED_DOC_NO"/>
        <result property="tempSaveYn" column="TEMP_SAVE_YN"/>
        
        <result property="empName" column="EMP_NAME"/>
        <result property="deptName" column="DEPT_NAME"/>
        
        <result property="vacationType" column="VACATION_TYPE"/>
        <result property="startDate" column="START_DATE"/>
        <result property="endDate" column="END_DATE"/>
        <result property="totalUse" column="TOTAL_USE"/>
        
        <result property="totalAmount" column="TOTAL_AMOUNT"/>
    </resultMap>

    <select id="selectNextDocNo" resultType="string">
        SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LTRIM(TO_CHAR(SEQ_DOC_NO.NEXTVAL, '0000000')) FROM DUAL
    </select>
    
    <insert id="insertApproval" parameterType="approvalDto">
        INSERT INTO "APPROVAL" (
            DOC_NO, EMP_NO, APPROVAL_DATE, RETENTION_YEAR, 
            APPROVAL_TITLE, APPROVAL_CONTENT, APPROVAL_STATUS, 
            APPROVAL_FILE, TEMP_SAVE_YN
        ) VALUES (
            #{docNo}, #{empNo}, SYSDATE, #{retentionYear}, 
            #{approvalTitle}, #{approvalContent}, 'W', 
            #{approvalFile, jdbcType=VARCHAR}, 
            NVL(#{tempSaveYn, jdbcType=VARCHAR}, 'N')
        )
    </insert>
    
    <insert id="insertApprovalLine" parameterType="ApprovalLineDto">
        INSERT INTO "APPROVAL_LINE" (
            APPLINE_NO, DOC_NO, APPROVER_NO, APPLINE_ORDER, APPLINE_STATUS
        ) VALUES (
            SEQ_APPLINE_NO.NEXTVAL, #{docNo}, #{approverNo}, #{appLineOrder}, 'W'
        )
    </insert>

    <insert id="insertApprovalExpense" parameterType="approvalDto">
        INSERT INTO APPROVAL_EXPENSE (DOC_NO, TOTAL_AMOUNT) 
        VALUES (#{docNo}, #{totalAmount})
    </insert>

    <insert id="insertExpenseDetail" parameterType="ExpenseDetailDto">
        INSERT INTO EXPENSE_DETAIL (
            DETAIL_NO, DOC_NO, EXPENSE_DATE, CATEGORY, USAGE_DETAIL, AMOUNT, NOTE
        ) VALUES (
            SEQ_EXPENSE_DETAIL_NO.NEXTVAL, #{docNo}, #{expenseDate}, #{category}, #{usageDetail}, #{amount}, #{note}
        )
    </insert>
    
    <insert id="insertApprovalVacation" parameterType="approvalDto">
        INSERT INTO APPROVAL_VACATION (
            DOC_NO, VACATION_TYPE, START_DATE, END_DATE, TOTAL_USE
        ) VALUES (
            #{docNo}, #{vacationType}, 
            TO_DATE(#{startDate}, 'YYYY-MM-DD'), 
            TO_DATE(#{endDate}, 'YYYY-MM-DD'), 
            #{totalUse}
        )
    </insert>

    <select id="selectApprovalDetail" resultMap="approvalResultMap">
        SELECT 
            A.DOC_NO, A.EMP_NO, A.RETENTION_YEAR, A.APPROVAL_TITLE, A.APPROVAL_CONTENT, 
            A.APPROVAL_STATUS, A.APPROVAL_FILE, A.TEMP_SAVE_YN,
            TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS APPROVAL_DATE,
            E.EMP_NAME, D.DEPT_NAME,
            V.VACATION_TYPE, 
            TO_CHAR(V.START_DATE, 'YYYY-MM-DD') AS START_DATE, 
            TO_CHAR(V.END_DATE, 'YYYY-MM-DD') AS END_DATE, 
            V.TOTAL_USE,
            X.TOTAL_AMOUNT
        FROM APPROVAL A
        JOIN EMPLOYEE E ON A.EMP_NO = E.EMP_NO
        LEFT JOIN DEPARTMENT D ON E.DEPT_CODE = D.DEPT_CODE
        LEFT JOIN APPROVAL_VACATION V ON A.DOC_NO = V.DOC_NO
        LEFT JOIN APPROVAL_EXPENSE X ON A.DOC_NO = X.DOC_NO
        WHERE A.DOC_NO = #{docNo}
    </select>

    <select id="selectApprovalLineList" resultType="ApprovalLineDto">
        SELECT 
            L.APPLINE_NO     AS "appLineNo",
            L.DOC_NO         AS "docNo",
            L.APPROVER_NO    AS "approverNo",
            L.APPLINE_ORDER  AS "appLineOrder",
            L.APPLINE_STATUS AS "appLineStatus",
            TO_CHAR(L.APPLINE_DATE, 'YYYY-MM-DD') AS "appLineDate",
            L.REJECT_REASON  AS "rejectReason",
            E.EMP_NAME       AS "empName",
            P.POSITION_NAME  AS "positionName",
            D.DEPT_NAME      AS "deptName"
        FROM APPROVAL_LINE L
        JOIN EMPLOYEE E ON L.APPROVER_NO = E.EMP_NO
        LEFT JOIN "POSITION" P ON E.POSITION_CODE = P.POSITION_CODE
        LEFT JOIN DEPARTMENT D ON E.DEPT_CODE = D.DEPT_CODE
        WHERE L.DOC_NO = #{docNo}
        ORDER BY L.APPLINE_ORDER ASC
    </select>

    <select id="selectWaitList" resultMap="approvalResultMap">
        SELECT 
            A.DOC_NO, A.APPROVAL_TITLE, 
            TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS APPROVAL_DATE, 
            A.APPROVAL_STATUS, E.EMP_NAME
        FROM APPROVAL A 
        JOIN APPROVAL_LINE L ON A.DOC_NO = L.DOC_NO 
        JOIN EMPLOYEE E ON A.EMP_NO = E.EMP_NO
        WHERE L.APPROVER_NO = #{empNo} 
          AND L.APPLINE_STATUS = 'W' 
          AND A.APPROVAL_STATUS = 'W' 
          AND A.TEMP_SAVE_YN = 'N'
          AND NOT EXISTS (
              SELECT 1 FROM APPROVAL_LINE PREV 
              WHERE PREV.DOC_NO = A.DOC_NO 
                AND PREV.APPLINE_ORDER &lt; L.APPLINE_ORDER 
                AND PREV.APPLINE_STATUS = 'W'
          )
        ORDER BY A.DOC_NO DESC
    </select>

    <select id="selectMyDraftList" resultMap="approvalResultMap">
        SELECT 
            DOC_NO, APPROVAL_TITLE, 
            TO_CHAR(APPROVAL_DATE, 'YYYY-MM-DD') AS APPROVAL_DATE, 
            APPROVAL_STATUS
        FROM APPROVAL 
        WHERE EMP_NO = #{empNo} 
          AND TEMP_SAVE_YN = 'N' 
          AND APPROVAL_STATUS = 'W' 
        ORDER BY DOC_NO DESC
    </select>

    <select id="selectTempList" resultMap="approvalResultMap">
        SELECT 
            DOC_NO, APPROVAL_TITLE, 
            TO_CHAR(APPROVAL_DATE, 'YYYY-MM-DD') AS APPROVAL_DATE, 
            APPROVAL_STATUS, TEMP_SAVE_YN
        FROM APPROVAL 
        WHERE EMP_NO = #{empNo} 
          AND TEMP_SAVE_YN = 'Y' 
        ORDER BY DOC_NO DESC
    </select>
    
	<select id="selectMyApprovedList" resultMap="approvalResultMap">
        SELECT 
            A.DOC_NO, 
            A.APPROVAL_TITLE, 
            TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS APPROVAL_DATE, -- 기안일
            A.APPROVAL_STATUS, 
            E.EMP_NAME,
            
            (SELECT TO_CHAR(MAX(L.APPLINE_DATE), 'YYYY-MM-DD')
             FROM APPROVAL_LINE L 
             WHERE L.DOC_NO = A.DOC_NO AND L.APPLINE_STATUS IN ('C', 'R')
            ) AS "appLineDate"
            
        FROM APPROVAL A 
        JOIN EMPLOYEE E ON A.EMP_NO = E.EMP_NO
        WHERE (
            A.EMP_NO = #{empNo} 
            OR EXISTS (SELECT 1 FROM APPROVAL_LINE L WHERE L.DOC_NO = A.DOC_NO AND L.APPROVER_NO = #{empNo})
        )
        AND A.APPROVAL_STATUS IN ('C', 'R') 
        ORDER BY "appLineDate" DESC
    </select>

    <select id="selectVacationDetail" resultMap="approvalResultMap">
        SELECT * FROM APPROVAL_VACATION WHERE DOC_NO = #{docNo}
    </select>

    <select id="selectExpenseDetail" resultMap="approvalResultMap">
        SELECT * FROM APPROVAL_EXPENSE WHERE DOC_NO = #{docNo}
    </select>

    <select id="selectExpenseDetailList" resultType="ExpenseDetailDto">
        SELECT 
            DETAIL_NO    AS "detailNo",
            DOC_NO       AS "docNo",
            EXPENSE_DATE AS "expenseDate",
            CATEGORY     AS "category",
            USAGE_DETAIL AS "usageDetail",
            AMOUNT       AS "amount",
            NOTE         AS "note"
        FROM EXPENSE_DETAIL 
        WHERE DOC_NO = #{docNo}
    </select>

    <update id="updateApproval">
        UPDATE APPROVAL 
        SET APPROVAL_TITLE = #{approvalTitle}, 
            APPROVAL_CONTENT = #{approvalContent}, 
            TEMP_SAVE_YN = #{tempSaveYn}, 
            APPROVAL_DATE = SYSDATE 
        WHERE DOC_NO = #{docNo}
    </update>

    <update id="updateApprovalLineStatus">
        UPDATE APPROVAL_LINE 
        SET APPLINE_STATUS = #{appLineStatus}, 
            APPLINE_DATE = SYSDATE, 
            REJECT_REASON = #{rejectReason, jdbcType=VARCHAR}
        WHERE DOC_NO = #{docNo} AND APPROVER_NO = #{approverNo}
    </update>

    <update id="updateApprovalStatus">
        UPDATE APPROVAL SET APPROVAL_STATUS = #{approvalStatus} WHERE DOC_NO = #{docNo}
    </update>

    <update id="updateApprovalToTemp">
        UPDATE APPROVAL SET TEMP_SAVE_YN = 'Y', APPROVAL_STATUS = 'W' WHERE DOC_NO = #{docNo}
    </update>

    <delete id="deleteApproval"> DELETE FROM APPROVAL WHERE DOC_NO = #{docNo} </delete>
    <delete id="deleteApprovalLine"> DELETE FROM APPROVAL_LINE WHERE DOC_NO = #{docNo} </delete>
    <delete id="deleteApprovalVacation"> DELETE FROM APPROVAL_VACATION WHERE DOC_NO = #{docNo} </delete>
    <delete id="deleteApprovalExpense"> DELETE FROM APPROVAL_EXPENSE WHERE DOC_NO = #{docNo} </delete>
    <delete id="deleteExpenseDetail"> DELETE FROM EXPENSE_DETAIL WHERE DOC_NO = #{docNo} </delete>

    <select id="countRemainingApprovers" resultType="_int">
        SELECT COUNT(*) FROM APPROVAL_LINE WHERE DOC_NO = #{docNo} AND APPLINE_STATUS = 'W'
    </select>

    <select id="countApprovedLines" resultType="_int">
        SELECT COUNT(*) FROM APPROVAL_LINE WHERE DOC_NO = #{docNo} AND APPLINE_STATUS IN ('C', 'R')
    </select>

    <select id="countWait" resultType="_int">
        SELECT COUNT(*) FROM APPROVAL_LINE L JOIN APPROVAL A ON L.DOC_NO = A.DOC_NO
        WHERE L.APPROVER_NO = #{empNo} AND L.APPLINE_STATUS = 'W' AND A.APPROVAL_STATUS = 'W' AND A.TEMP_SAVE_YN = 'N'
    </select>

    <select id="countDraft" resultType="_int">
        SELECT COUNT(*) FROM APPROVAL WHERE EMP_NO = #{empNo} AND APPROVAL_STATUS = 'W' AND TEMP_SAVE_YN = 'N'
    </select>

<select id="countApproved" resultType="_int">
        SELECT COUNT(*) 
        FROM APPROVAL A
        WHERE A.EMP_NO = #{empNo} 
          AND A.APPROVAL_STATUS IN ('C', 'R')
          AND A.TEMP_SAVE_YN = 'N'
          AND EXISTS (
              SELECT 1 
              FROM APPROVAL_LINE L
              WHERE L.DOC_NO = A.DOC_NO
                AND L.APPLINE_STATUS IN ('C', 'R') 
                AND TO_CHAR(L.APPLINE_DATE, 'YYYYMMDD') = TO_CHAR(SYSDATE, 'YYYYMMDD')
          )
    </select>

    <select id="selectWaitListTop5" resultMap="approvalResultMap">
        SELECT * FROM (
            SELECT A.DOC_NO, A.APPROVAL_TITLE, TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS APPROVAL_DATE, E.EMP_NAME
            FROM APPROVAL_LINE L JOIN APPROVAL A ON L.DOC_NO = A.DOC_NO JOIN EMPLOYEE E ON A.EMP_NO = E.EMP_NO
            WHERE L.APPROVER_NO = #{empNo} AND L.APPLINE_STATUS = 'W' AND A.APPROVAL_STATUS = 'W' AND A.TEMP_SAVE_YN = 'N'
            ORDER BY A.APPROVAL_DATE DESC
        ) WHERE ROWNUM &lt;= 5
    </select>

    <select id="selectDraftListTop5" resultMap="approvalResultMap">
        SELECT * FROM (
            SELECT DOC_NO, APPROVAL_TITLE, TO_CHAR(APPROVAL_DATE, 'YYYY-MM-DD') AS APPROVAL_DATE
            FROM APPROVAL WHERE EMP_NO = #{empNo} AND APPROVAL_STATUS = 'W' AND TEMP_SAVE_YN = 'N'
            ORDER BY APPROVAL_DATE DESC
        ) WHERE ROWNUM &lt;= 5
    </select>

    <select id="selectTotalVacation" resultType="TotalVacationDto">
        SELECT * FROM TOTAL_VACATION WHERE EMP_NO = #{empNo} AND YEAR = #{year}
    </select>

    <update id="updateVacationUsage">
        UPDATE TOTAL_VACATION SET USED_DAYS = USED_DAYS + #{count}, REMAIN_DAYS = REMAIN_DAYS - #{count}
        WHERE EMP_NO = #{empNo} AND YEAR = #{year}
    </update>

    <select id="selectAllActiveEmpNos" resultType="string">
        SELECT EMP_NO FROM EMPLOYEE WHERE EMP_DEL_FL = 'N'
    </select>

    <select id="countVacationData" resultType="_int">
        SELECT COUNT(*) FROM TOTAL_VACATION WHERE EMP_NO = #{empNo} AND YEAR = #{year}
    </select>

    <insert id="insertTotalVacation" parameterType="TotalVacationDto">
        INSERT INTO TOTAL_VACATION (YEAR, EMP_NO, TOTAL_DAYS, USED_DAYS, REMAIN_DAYS) 
        VALUES (#{year}, #{empNo}, #{totalDays}, 0, #{remainDays})
    </insert>

    <select id="selectHolidayList" resultType="string">
        SELECT TO_CHAR(START_DATE, 'YYYYMMDD') FROM CALENDAR 
        WHERE TYPE_ID = '3' AND CAL_CONTENT = '공휴일'
        AND TO_CHAR(START_DATE, 'YYYYMMDD') BETWEEN REPLACE(#{startDate}, '-', '') AND REPLACE(#{endDate}, '-', '')
    </select>

    <select id="selectDeductYn" resultType="string">
        SELECT DEDUCTION_YN FROM VACATION_TYPE WHERE VACATION_TYPE = #{type}
    </select>

<select id="selectSidebarCounts" resultType="map">
        SELECT 
            -- 1. 결재 대기 문서 (내가 결재할 차례인 문서)
            (SELECT COUNT(*) 
             FROM APPROVAL_LINE L 
             JOIN APPROVAL A ON L.DOC_NO = A.DOC_NO 
             WHERE L.APPROVER_NO = #{empNo} 
               AND L.APPLINE_STATUS = 'W' 
               AND A.APPROVAL_STATUS = 'W' 
               AND A.TEMP_SAVE_YN = 'N'
               AND NOT EXISTS (
                   SELECT 1 FROM APPROVAL_LINE PREV 
                   WHERE PREV.DOC_NO = A.DOC_NO 
                     AND PREV.APPLINE_ORDER &lt; L.APPLINE_ORDER 
                     AND PREV.APPLINE_STATUS = 'W'
               )
            ) AS "waitCount",

            -- 2. 결재 예정 문서 (나는 결재자지만, 아직 내 차례가 아닌 문서)
            (SELECT COUNT(*) 
             FROM APPROVAL_LINE L 
             JOIN APPROVAL A ON L.DOC_NO = A.DOC_NO 
             WHERE L.APPROVER_NO = #{empNo} 
               AND L.APPLINE_STATUS = 'W' 
               AND A.APPROVAL_STATUS = 'W' 
               AND A.TEMP_SAVE_YN = 'N'
               AND EXISTS (
                   SELECT 1 FROM APPROVAL_LINE PREV 
                   WHERE PREV.DOC_NO = A.DOC_NO 
                     AND PREV.APPLINE_ORDER &lt; L.APPLINE_ORDER 
                     AND PREV.APPLINE_STATUS = 'W'
               )
            ) AS "upcomingCount",

            -- 3. 기안 문서함 (내가 쓴 기안 중 진행 중인 것)
            (SELECT COUNT(*) 
             FROM APPROVAL 
             WHERE EMP_NO = #{empNo} 
               AND APPROVAL_STATUS = 'W' 
               AND TEMP_SAVE_YN = 'N'
            ) AS "draftCount",

            -- 4. 임시 저장함 (내가 임시 저장한 것)
            (SELECT COUNT(*) 
             FROM APPROVAL 
             WHERE EMP_NO = #{empNo} 
               AND TEMP_SAVE_YN = 'Y'
            ) AS "tempCount"

            
        FROM DUAL
    </select>

    <select id="selectUpcomingList" resultMap="approvalResultMap">
        SELECT 
            A.DOC_NO, A.APPROVAL_TITLE, TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS APPROVAL_DATE, 
            A.APPROVAL_STATUS, E.EMP_NAME
        FROM APPROVAL A 
        JOIN APPROVAL_LINE L ON A.DOC_NO = L.DOC_NO 
        JOIN EMPLOYEE E ON A.EMP_NO = E.EMP_NO
        WHERE L.APPROVER_NO = #{empNo} 
          AND L.APPLINE_STATUS = 'W' 
          AND A.APPROVAL_STATUS = 'W' 
          AND A.TEMP_SAVE_YN = 'N'
          AND EXISTS (
              SELECT 1 FROM APPROVAL_LINE PREV 
              WHERE PREV.DOC_NO = A.DOC_NO 
                AND PREV.APPLINE_ORDER &lt; L.APPLINE_ORDER 
                AND PREV.APPLINE_STATUS = 'W'
          )
        ORDER BY A.DOC_NO DESC
    </select>

</mapper>